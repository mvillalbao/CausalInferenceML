
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lab 1 - R Code &#8212; Causal Inference and ML Course</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'labs/lab_1/group3_lab1_r';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Lab 1 - Julia Code" href="group3_lab1_julia.html" />
    <link rel="prev" title="Lab 1 - Python Code" href="group3_lab1_python.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/p4_output_39_0.png" class="logo__image only-light" alt="Causal Inference and ML Course - Home"/>
    <script>document.write(`<img src="../../_static/p4_output_39_0.png" class="logo__image only-dark" alt="Causal Inference and ML Course - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Causal Inference & Machine Learning Course
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Labs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../lab_1_md.html">1. Intro to Partialling-out and Lasso Cross-validation</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="group3_lab1_python.html">Lab 1 - Python Code</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Lab 1 - R Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="group3_lab1_julia.html">Lab 1 - Julia Code</a></li>


</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lab_2_md.html">2. Multicollinearity, Precision Adjustment, and DAGs for Good and Bad controls</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lab_2/group3_lab2_python.html">Lab 2 - Python Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab_2/group3_lab2_r.html">Lab 2 - R Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab_2/group3_lab2_julia.html">Lab 2 - Julia Code</a></li>


</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lab_3_md.html">3. Neyman Orthogonality, Orthogonal Learning, and Double Lasso</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lab_3/group3_lab3_python.html">Lab 3 - Python Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab_3/group3_lab3_r.html">Lab 3 - R Code</a></li>


<li class="toctree-l2"><a class="reference internal" href="../lab_3/group3_lab3_julia.html">Lab 3 - Julia Code</a></li>


</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lab_4_md.html">4. Bootstraping and Causal Forest Analysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lab_4/group3_lab4_python.html">Lab 4 - Python Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab_4/group3_lab4_r.html">Lab 4 - R Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab_4/group3_lab4_julia.html">Lab 4 - Julia Code</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lab_5_md.html">5. Double Machine Learning</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lab_5/group3_lab5_python.html">Lab 5 - Python Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab_5/group3_lab5_r.html">Lab 5 - R Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lab_5/group3_lab5_julia.html">Lab 5 - Julia Code</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reports</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../reports/000199908_r1.html">Report 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reports/000199908_r2.html">Report 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reports/000199908_r3.html">Report 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reports/000199908_r4.html">Report 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reports/000199908_r5.html">Report 5</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Flabs/lab_1/group3_lab1_r.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/labs/lab_1/group3_lab1_r.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lab 1 - R Code</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#math-demonstrations"><strong>Math Demonstrations</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prove-the-frisch-waugh-lovell-theorem">1. Prove the Frisch-Waugh-Lovell theorem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#show-that-the-conditional-expectation-function-minimizes-expected-squared-error">2. Show that the Conditional Expectation Function minimizes expected squared error</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-1-code"><strong>Replication 1 - Code</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-analysis">Data analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering-data-to-focus-on-college-advanced-educated-workers">Filtering data to focus on college-advanced-educated workers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploratory-data-analysis">Exploratory Data Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-validation-in-lasso-regression-manual-implementation-task"><strong>Cross-Validation in Lasso Regression - Manual Implementation Task</strong></a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lab-1-r-code">
<h1>Lab 1 - R Code<a class="headerlink" href="#lab-1-r-code" title="Link to this heading">#</a></h1>
<section id="math-demonstrations">
<h2><strong>Math Demonstrations</strong><a class="headerlink" href="#math-demonstrations" title="Link to this heading">#</a></h2>
<section id="prove-the-frisch-waugh-lovell-theorem">
<h3>1. Prove the Frisch-Waugh-Lovell theorem<a class="headerlink" href="#prove-the-frisch-waugh-lovell-theorem" title="Link to this heading">#</a></h3>
<p>Given the model:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
y &amp;= D \beta_1 + W \beta_2 + \mu
\end{align*}
\]</div>
<p>where <span class="math notranslate nohighlight">\(y\)</span> is an <span class="math notranslate nohighlight">\(n \times 1\)</span> vector, <span class="math notranslate nohighlight">\(D\)</span> is an <span class="math notranslate nohighlight">\(n \times k_1\)</span> matrix, <span class="math notranslate nohighlight">\(\beta_1\)</span> is a <span class="math notranslate nohighlight">\(k_1 \times 1\)</span> vector, <span class="math notranslate nohighlight">\(W\)</span> is an <span class="math notranslate nohighlight">\(n \times k_2\)</span> matrix, <span class="math notranslate nohighlight">\(\beta_2\)</span> is a <span class="math notranslate nohighlight">\(k_2 \times 1\)</span> vector, and <span class="math notranslate nohighlight">\(\mu\)</span> is an <span class="math notranslate nohighlight">\(n \times 1\)</span> vector of error terms.</p>
<p>We can construct the following equation:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
\epsilon_y &amp;= \epsilon_D \phi + \xi
\end{align*}
\]</div>
<p>Running <span class="math notranslate nohighlight">\(y\)</span> on <span class="math notranslate nohighlight">\(W\)</span>, we get:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
y &amp;= W\hat{\alpha}_1 + \epsilon_y \iff \epsilon_y = y - W\hat{\alpha}_1
\end{align*}
\]</div>
<p>Similarly, running <span class="math notranslate nohighlight">\(D\)</span> on <span class="math notranslate nohighlight">\(W\)</span> gives us:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
D &amp;= W\hat{\alpha}_2 + \epsilon_D \iff \epsilon_D = D - W\hat{\alpha}_2
\end{align*}
\]</div>
<p>Running <span class="math notranslate nohighlight">\(\epsilon_y\)</span> on <span class="math notranslate nohighlight">\(\epsilon_D\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
y - W \hat{\alpha}_1 &amp;= (D - W \hat{\alpha}_2) \phi + \xi \\
y &amp;= W \hat{\alpha}_1 + (D - W \hat{\alpha}_2) \phi + \xi \\
y &amp;= W \hat{\alpha}_1 + D \phi - W \hat{\alpha}_2 \phi + \xi \\
y &amp;= D \phi + W (\hat{\alpha}_1 - \hat{\alpha}_2 \phi) + \xi
\end{align*}
\end{split}\]</div>
<p>Comparing the original model with this, we can see that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
    \beta_1 &amp;= \phi \\
    \beta_2 &amp;= \hat{\alpha}_1 - \hat{\alpha}_2 \phi \\
    \mu &amp;= \xi
\end{align*}
\end{split}\]</div>
</section>
<section id="show-that-the-conditional-expectation-function-minimizes-expected-squared-error">
<h3>2. Show that the Conditional Expectation Function minimizes expected squared error<a class="headerlink" href="#show-that-the-conditional-expectation-function-minimizes-expected-squared-error" title="Link to this heading">#</a></h3>
<p>Given the model:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
Y &amp;= m(X) + e
\end{align*}
\]</div>
<p>where <span class="math notranslate nohighlight">\(m(X)\)</span> represents the conditional expectation of <span class="math notranslate nohighlight">\(Y\)</span> on <span class="math notranslate nohighlight">\(X\)</span>. Let’s define an arbitrary model:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
Y &amp;= g(X) + w
\end{align*}
\]</div>
<p>where <span class="math notranslate nohighlight">\(g(X)\)</span> represents any function of <span class="math notranslate nohighlight">\(X\)</span>.</p>
<p>Working with the expected squared error from the arbitrary model:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
E[(Y-g(X))^2] &amp;= E[(Y-m(X) + m(X)-g(X))^2] \\
&amp;= E[(Y-m(X))^2 + 2(Y-m(X))(m(X)-g(X)) + (m(X)-g(X))^2] \\
&amp;= E[e^2] + 2E[(Y-m(X))(m(X)-g(X))] + E[(m(X)-g(X))^2]
\end{align*}
\end{split}\]</div>
<p>Using the law of iterated expectations:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
E[(Y-g(X))^2] &amp;= E[e^2] + 2E[E[(Y-m(X))(m(X)-g(X)) \mid X]] + E[(m(X)-g(X))^2]
\end{align*}
\]</div>
<p>Since <span class="math notranslate nohighlight">\(m(X)\)</span> and <span class="math notranslate nohighlight">\(g(X)\)</span> are functions of <span class="math notranslate nohighlight">\(X\)</span>, the term <span class="math notranslate nohighlight">\((m(X)-g(X))\)</span> can be thought of as constant when conditioning on <span class="math notranslate nohighlight">\(X\)</span>. Thus:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
E[(Y-g(X))^2] &amp;= E[e^2] + 2E[E[Y-m(X) \mid X](m(X)-g(X))] + E[(m(X)-g(X))^2]
\end{align*}
\]</div>
<p>It is important to note that <span class="math notranslate nohighlight">\(E[Y-m(X) \mid X] = 0\)</span> by definition of <span class="math notranslate nohighlight">\(m(X)\)</span>, so we get:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
E[(Y-g(X))^2] &amp;= E[e^2] + E[(m(X)-g(X))^2]
\end{align*}
\]</div>
<p>Because the second term in the equation is always non-negative, it is clear that the function is minimized when <span class="math notranslate nohighlight">\(g(X)\)</span> equals <span class="math notranslate nohighlight">\(m(X)\)</span>. In which case:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
E[(Y-g(X))^2] &amp;= E[e^2]
\end{align*}
\]</div>
</section>
</section>
<section id="replication-1-code">
<h2><strong>Replication 1 - Code</strong><a class="headerlink" href="#replication-1-code" title="Link to this heading">#</a></h2>
<p>In the previous lab, we already analyzed data from the March Supplement of the U.S. Current Population Survey (2015) and answered the question how to use job-relevant characteristics, such as education and experience, to best predict wages. Now, we focus on the following inference question:</p>
<p>What is the difference in predicted wages between men and women with the same job-relevant characteristics?</p>
<p>Thus, we analyze if there is a difference in the payment of men and women (<em>gender wage gap</em>). The gender wage gap may partly reflect <em>discrimination</em> against women in the labor market or may partly reflect a <em>selection effect</em>, namely that women are relatively more likely to take on occupations that pay somewhat less (for example, school teaching).</p>
<p>To investigate the gender wage gap, we consider the following log-linear regression model</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
\log(Y) &amp;= \beta'X + \epsilon\\
&amp;= \beta_1 D  + \beta_2' W + \epsilon,
\end{align}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(D\)</span> is the indicator of being female (<span class="math notranslate nohighlight">\(1\)</span> if female and <span class="math notranslate nohighlight">\(0\)</span> otherwise) and the
<span class="math notranslate nohighlight">\(W\)</span>’s are controls explaining variation in wages. Considering transformed wages by the logarithm, we are analyzing the relative difference in the payment of men and women.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="data-analysis">
<h3>Data analysis<a class="headerlink" href="#data-analysis" title="Link to this heading">#</a></h3>
<p>We consider the same subsample of the U.S. Current Population Survey (2015) as in the previous lab. Let us load the data set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">load</span><span class="p">(</span><span class="s">&quot;../../data/wage2015_subsample_inference.Rdata&quot;</span><span class="p">)</span>
<span class="nf">dim</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>5150</li><li>20</li></ol>
</div></div>
</div>
<p><em><strong>Variable description</strong></em></p>
<ul class="simple">
<li><p>occ : occupational classification</p></li>
<li><p>ind : industry classification</p></li>
<li><p>lwage : log hourly wage</p></li>
<li><p>sex : gender (1 female) (0 male)</p></li>
<li><p>shs : some high school</p></li>
<li><p>hsg : High school graduated</p></li>
<li><p>scl : Some College</p></li>
<li><p>clg: College Graduate</p></li>
<li><p>ad: Advanced Degree</p></li>
<li><p>ne: Northeast</p></li>
<li><p>mw: Midwest</p></li>
<li><p>so: South</p></li>
<li><p>we: West</p></li>
<li><p>exp1: experience</p></li>
</ul>
</section>
<section id="filtering-data-to-focus-on-college-advanced-educated-workers">
<h3>Filtering data to focus on college-advanced-educated workers<a class="headerlink" href="#filtering-data-to-focus-on-college-advanced-educated-workers" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">$</span><span class="n">ad</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="o">$</span><span class="n">scl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="o">$</span><span class="n">clg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nf">colnames</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
<span class="nf">attach</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="c1"># make each variable as an object </span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="exploratory-data-analysis">
<h3>Exploratory Data Analysis<a class="headerlink" href="#exploratory-data-analysis" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">colnames</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'wage'</li><li>'lwage'</li><li>'sex'</li><li>'shs'</li><li>'hsg'</li><li>'scl'</li><li>'clg'</li><li>'ad'</li><li>'mw'</li><li>'so'</li><li>'we'</li><li>'ne'</li><li>'exp1'</li><li>'exp2'</li><li>'exp3'</li><li>'exp4'</li><li>'occ'</li><li>'occ2'</li><li>'ind'</li><li>'ind2'</li></ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">###################### Lorenz Curve for Salaries by Deciles for the subgroup of individuals who accessed higher education ######################</span>
<span class="c1"># Sort wages in ascending order</span>
<span class="n">wage_sorted</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sort</span><span class="p">(</span><span class="n">wage</span><span class="p">)</span>
<span class="c1"># Compute the cumulative sum of sorted wages</span>
<span class="n">cumulative_sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">cumsum</span><span class="p">(</span><span class="n">wage_sorted</span><span class="p">)</span>
<span class="c1"># Calculate the deciles of the cumulative sum of wages</span>
<span class="n">deciles</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quantile</span><span class="p">(</span><span class="n">cumulative_sum</span><span class="p">,</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">))</span>

<span class="c1"># Create a vector for the cumulative fraction of the population for x-axis</span>
<span class="n">population_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)</span>

<span class="c1"># Calculate the cumulative fraction of salaries</span>
<span class="n">salary_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quantile</span><span class="p">(</span><span class="n">deciles</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">wage</span><span class="p">),</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">))</span>

<span class="c1"># Plot the Lorenz curve</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">population_fraction</span><span class="p">,</span><span class="w"> </span><span class="n">salary_fraction</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lorenz Curve for Higher Education Salaries&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cumulative fraction of the population&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cumulative fraction of salaries&quot;</span><span class="p">)</span>
<span class="nf">abline</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># Equality line</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/a3450b3b0474b8bf7e5eda5d4cde24445c3267e7bb548fb0e6419bce8690324e.png"><img alt="../../_images/a3450b3b0474b8bf7e5eda5d4cde24445c3267e7bb548fb0e6419bce8690324e.png" src="../../_images/a3450b3b0474b8bf7e5eda5d4cde24445c3267e7bb548fb0e6419bce8690324e.png" style="width: 420px; height: 420px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">########################### Histogram for lwage ###########################</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lwage</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">..density..</span><span class="p">),</span><span class="w"> </span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;lightblue&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_density</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Histogram of Salaries with Density Function&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lwage&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Density&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_minimal</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
&quot;Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
<span class=" -Color -Color-Cyan">ℹ</span> Please use `linewidth` instead.&quot;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
&quot;The dot-dot notation (`..density..`) was deprecated in ggplot2 3.4.0.
<span class=" -Color -Color-Cyan">ℹ</span> Please use `after_stat(density)` instead.&quot;
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/c364f1664e37b4913c50bfca3279abdf4c0505f9baec36d6d553391c9ee07643.png"><img alt="../../_images/c364f1664e37b4913c50bfca3279abdf4c0505f9baec36d6d553391c9ee07643.png" src="../../_images/c364f1664e37b4913c50bfca3279abdf4c0505f9baec36d6d553391c9ee07643.png" style="width: 420px; height: 420px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">############################Graph bar sex</span>
<span class="n">total_observations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">nrow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">proportions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">prop.table</span><span class="p">(</span><span class="nf">table</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">sex</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span>
<span class="n">plot_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">sex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">proportions</span><span class="p">),</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Male&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Female&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">proportion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">proportions</span><span class="p">))</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sex</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proportion</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sex</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Proportion of Male and Female Individuals with Higher Education&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Sex (0 = Male, 1 = Female)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Percentage&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Sex&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_minimal</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_text</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">proportion</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-0.5</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_text</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">plot_data</span><span class="o">$</span><span class="n">proportion</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.9</span><span class="p">,</span>
<span class="w">                </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Total observations:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">total_observations</span><span class="p">)),</span><span class="w"> </span>
<span class="w">            </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">guides</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">guide_legend</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Sex&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
&quot;Use of `plot_data$proportion` is discouraged.
<span class=" -Color -Color-Cyan">ℹ</span> Use `proportion` instead.&quot;
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/9046266b079c5e3d73b11f787a5f7fe9a585041284e540e279b31d1d4f4d8501.png"><img alt="../../_images/9046266b079c5e3d73b11f787a5f7fe9a585041284e540e279b31d1d4f4d8501.png" src="../../_images/9046266b079c5e3d73b11f787a5f7fe9a585041284e540e279b31d1d4f4d8501.png" style="width: 420px; height: 420px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">########################Education Status&quot;Analysis of individuals who accessed higher education&quot;</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>

<span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Education_Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">    </span><span class="n">scl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;Some College&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">clg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;College Graduate&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">ad</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;Advanced Degree&quot;</span>
<span class="w">  </span><span class="p">))</span>

<span class="n">edu_freq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">count</span><span class="p">(</span><span class="n">Education_Status</span><span class="p">)</span>
<span class="n">total_obs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">edu_freq</span><span class="o">$</span><span class="n">n</span><span class="p">)</span>
<span class="n">edu_freq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">edu_freq</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Percentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total_obs</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span><span class="p">)</span>

<span class="c1"># Crear el gráfico de pastel</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">edu_freq</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Percentage</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Education_Status</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">coord_polar</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Education Status Distribution&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span>
<span class="w">       </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Education Status&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Total observations:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">total_obs</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scales</span><span class="o">::</span><span class="nf">percent_format</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">  </span>
<span class="w">  </span><span class="nf">geom_text</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">Percentage</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">position_stack</span><span class="p">(</span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">theme_void</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;right&quot;</span><span class="p">)</span><span class="w">  </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attaching package: &#39;dplyr&#39;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following objects are masked from &#39;package:stats&#39;:

    filter, lag
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following objects are masked from &#39;package:base&#39;:

    intersect, setdiff, setequal, union
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/5c46799138238a79d74bd68ec22890de661b97a5e296c5f238b558aeae3f9053.png"><img alt="../../_images/5c46799138238a79d74bd68ec22890de661b97a5e296c5f238b558aeae3f9053.png" src="../../_images/5c46799138238a79d74bd68ec22890de661b97a5e296c5f238b558aeae3f9053.png" style="width: 420px; height: 420px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#######################################Experience</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_boxplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Distribution of Experience in Individuals with Higher Education&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Experience (exp1)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/80d0ca85539cce53d08dd6aab4a75f5fb98611a0ac0c88ae59791b4b3538d790.png"><img alt="../../_images/80d0ca85539cce53d08dd6aab4a75f5fb98611a0ac0c88ae59791b4b3538d790.png" src="../../_images/80d0ca85539cce53d08dd6aab4a75f5fb98611a0ac0c88ae59791b4b3538d790.png" style="width: 420px; height: 420px;" /></a>
</div>
</div>
<p>To start our (causal) analysis, we compare the sample means given gender:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;xtable&quot;</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">xtable</span><span class="p">)</span>

<span class="n">Z</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="nf">which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;lwage&quot;</span><span class="p">,</span><span class="s">&quot;sex&quot;</span><span class="p">,</span><span class="s">&quot;shs&quot;</span><span class="p">,</span><span class="s">&quot;hsg&quot;</span><span class="p">,</span><span class="s">&quot;scl&quot;</span><span class="p">,</span><span class="s">&quot;clg&quot;</span><span class="p">,</span><span class="s">&quot;ad&quot;</span><span class="p">,</span><span class="s">&quot;ne&quot;</span><span class="p">,</span><span class="s">&quot;mw&quot;</span><span class="p">,</span><span class="s">&quot;so&quot;</span><span class="p">,</span><span class="s">&quot;we&quot;</span><span class="p">,</span><span class="s">&quot;exp1&quot;</span><span class="p">))]</span>

<span class="n">data_female</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">$</span><span class="n">sex</span><span class="o">==</span><span class="m">1</span><span class="p">,]</span>
<span class="n">Z_female</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_female</span><span class="p">[</span><span class="nf">which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;lwage&quot;</span><span class="p">,</span><span class="s">&quot;sex&quot;</span><span class="p">,</span><span class="s">&quot;shs&quot;</span><span class="p">,</span><span class="s">&quot;hsg&quot;</span><span class="p">,</span><span class="s">&quot;scl&quot;</span><span class="p">,</span><span class="s">&quot;clg&quot;</span><span class="p">,</span><span class="s">&quot;ad&quot;</span><span class="p">,</span><span class="s">&quot;ne&quot;</span><span class="p">,</span><span class="s">&quot;mw&quot;</span><span class="p">,</span><span class="s">&quot;so&quot;</span><span class="p">,</span><span class="s">&quot;we&quot;</span><span class="p">,</span><span class="s">&quot;exp1&quot;</span><span class="p">))]</span>


<span class="n">data_male</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">$</span><span class="n">sex</span><span class="o">==</span><span class="m">0</span><span class="p">,]</span>
<span class="n">Z_male</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_male</span><span class="p">[</span><span class="nf">which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;lwage&quot;</span><span class="p">,</span><span class="s">&quot;sex&quot;</span><span class="p">,</span><span class="s">&quot;shs&quot;</span><span class="p">,</span><span class="s">&quot;hsg&quot;</span><span class="p">,</span><span class="s">&quot;scl&quot;</span><span class="p">,</span><span class="s">&quot;clg&quot;</span><span class="p">,</span><span class="s">&quot;ad&quot;</span><span class="p">,</span><span class="s">&quot;ne&quot;</span><span class="p">,</span><span class="s">&quot;mw&quot;</span><span class="p">,</span><span class="s">&quot;so&quot;</span><span class="p">,</span><span class="s">&quot;we&quot;</span><span class="p">,</span><span class="s">&quot;exp1&quot;</span><span class="p">))]</span>

<span class="n">table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
<span class="n">table</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">]</span><span class="w">   </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">lapply</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">mean</span><span class="p">))</span>
<span class="n">table</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">12</span><span class="p">,</span><span class="m">2</span><span class="p">]</span><span class="w">   </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">lapply</span><span class="p">(</span><span class="n">Z_male</span><span class="p">,</span><span class="n">mean</span><span class="p">))</span>
<span class="n">table</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">12</span><span class="p">,</span><span class="m">3</span><span class="p">]</span><span class="w">   </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">lapply</span><span class="p">(</span><span class="n">Z_female</span><span class="p">,</span><span class="n">mean</span><span class="p">))</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Log Wage&quot;</span><span class="p">,</span><span class="s">&quot;Sex&quot;</span><span class="p">,</span><span class="s">&quot;Less then High School&quot;</span><span class="p">,</span><span class="s">&quot;High School Graduate&quot;</span><span class="p">,</span><span class="s">&quot;Some College&quot;</span><span class="p">,</span><span class="s">&quot;Gollage Graduate&quot;</span><span class="p">,</span><span class="s">&quot;Advanced Degree&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Northeast&quot;</span><span class="p">,</span><span class="s">&quot;Midwest&quot;</span><span class="p">,</span><span class="s">&quot;South&quot;</span><span class="p">,</span><span class="s">&quot;West&quot;</span><span class="p">,</span><span class="s">&quot;Experience&quot;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;All&quot;</span><span class="p">,</span><span class="s">&quot;Men&quot;</span><span class="p">,</span><span class="s">&quot;Women&quot;</span><span class="p">)</span>
<span class="n">tab</span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">xtable</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span>
<span class="n">tab</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Installing package into &#39;C:/Users/Matias Villalba/AppData/Local/R/win-library/4.3&#39;
(as &#39;lib&#39; is unspecified)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>package &#39;xtable&#39; successfully unpacked and MD5 sums checked
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The downloaded binary packages are in
	C:\Users\Matias Villalba\AppData\Local\Temp\Rtmp044Si9\downloaded_packages
</pre></div>
</div>
<div class="output text_html"><table class="dataframe">
<caption>A xtable: 12 × 3</caption>
<thead>
	<tr><th></th><th scope=col>All</th><th scope=col>Men</th><th scope=col>Women</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>Log Wage</th><td> 3.0627476</td><td> 3.0994485</td><td> 3.0244165</td></tr>
	<tr><th scope=row>Sex</th><td> 0.4891362</td><td> 0.0000000</td><td> 1.0000000</td></tr>
	<tr><th scope=row>Less then High School</th><td> 0.0000000</td><td> 0.0000000</td><td> 0.0000000</td></tr>
	<tr><th scope=row>High School Graduate</th><td> 0.0000000</td><td> 0.0000000</td><td> 0.0000000</td></tr>
	<tr><th scope=row>Some College</th><td> 0.3794383</td><td> 0.4056017</td><td> 0.3521127</td></tr>
	<tr><th scope=row>Gollage Graduate</th><td> 0.4334923</td><td> 0.4362033</td><td> 0.4306609</td></tr>
	<tr><th scope=row>Advanced Degree</th><td> 0.1870694</td><td> 0.1581950</td><td> 0.2172264</td></tr>
	<tr><th scope=row>Northeast</th><td> 0.2498675</td><td> 0.2458506</td><td> 0.2540628</td></tr>
	<tr><th scope=row>Midwest</th><td> 0.2983572</td><td> 0.3034232</td><td> 0.2930661</td></tr>
	<tr><th scope=row>South</th><td> 0.2225755</td><td> 0.2308091</td><td> 0.2139762</td></tr>
	<tr><th scope=row>West</th><td> 0.2291998</td><td> 0.2199170</td><td> 0.2388949</td></tr>
	<tr><th scope=row>Experience</th><td>12.5102014</td><td>12.2022822</td><td>12.8317985</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span><span class="n">type</span><span class="o">=</span><span class="s">&quot;html&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1"># set type=&quot;latex&quot; for printing table in LaTeX</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;!-- html table generated in R 4.3.3 by xtable 1.8-4 package --&gt;
&lt;!-- Sat Jul 20 15:07:57 2024 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt;  &lt;/th&gt; &lt;th&gt; All &lt;/th&gt; &lt;th&gt; Men &lt;/th&gt; &lt;th&gt; Women &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; Log Wage &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3.0627 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3.0994 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3.0244 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; Sex &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.4891 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.0000 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1.0000 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; Less then High School &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.0000 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.0000 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.0000 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; High School Graduate &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.0000 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.0000 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.0000 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; Some College &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.3794 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.4056 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.3521 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; Gollage Graduate &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.4335 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.4362 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.4307 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; Advanced Degree &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.1871 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.1582 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2172 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; Northeast &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2499 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2459 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2541 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; Midwest &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2984 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.3034 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2931 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; South &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2226 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2308 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2140 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; West &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2292 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2199 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.2389 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; Experience &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 12.5102 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 12.2023 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 12.8318 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
</pre></div>
</div>
</div>
</div>
<!-- html table generated in R 4.3.3 by xtable 1.8-4 package -->
<!-- Sat Apr 13 20:46:24 2024 -->
<table border=1>
<tr> <th>  </th> <th> All </th> <th> Men </th> <th> Women </th>  </tr>
  <tr> <td align="right"> Log Wage </td> <td align="right"> 3.0627 </td> <td align="right"> 3.0994 </td> <td align="right"> 3.0244 </td> </tr>
  <tr> <td align="right"> Sex </td> <td align="right"> 0.4891 </td> <td align="right"> 0.0000 </td> <td align="right"> 1.0000 </td> </tr>
  <tr> <td align="right"> Less then High School </td> <td align="right"> 0.0000 </td> <td align="right"> 0.0000 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> High School Graduate </td> <td align="right"> 0.0000 </td> <td align="right"> 0.0000 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> Some College </td> <td align="right"> 0.3794 </td> <td align="right"> 0.4056 </td> <td align="right"> 0.3521 </td> </tr>
  <tr> <td align="right"> Gollage Graduate </td> <td align="right"> 0.4335 </td> <td align="right"> 0.4362 </td> <td align="right"> 0.4307 </td> </tr>
  <tr> <td align="right"> Advanced Degree </td> <td align="right"> 0.1871 </td> <td align="right"> 0.1582 </td> <td align="right"> 0.2172 </td> </tr>
  <tr> <td align="right"> Northeast </td> <td align="right"> 0.2499 </td> <td align="right"> 0.2459 </td> <td align="right"> 0.2541 </td> </tr>
  <tr> <td align="right"> Midwest </td> <td align="right"> 0.2984 </td> <td align="right"> 0.3034 </td> <td align="right"> 0.2931 </td> </tr>
  <tr> <td align="right"> South </td> <td align="right"> 0.2226 </td> <td align="right"> 0.2308 </td> <td align="right"> 0.2140 </td> </tr>
  <tr> <td align="right"> West </td> <td align="right"> 0.2292 </td> <td align="right"> 0.2199 </td> <td align="right"> 0.2389 </td> </tr>
  <tr> <td align="right"> Experience </td> <td align="right"> 12.5102 </td> <td align="right"> 12.2023 </td> <td align="right"> 12.8318 </td> </tr>
   </table><p>In particular, the table above shows that the difference in average <em>logwage</em> between men and women is equal to <span class="math notranslate nohighlight">\(0,075\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">mean</span><span class="p">(</span><span class="n">data_female</span><span class="o">$</span><span class="n">lwage</span><span class="p">)</span><span class="o">-</span><span class="nf">mean</span><span class="p">(</span><span class="n">data_male</span><span class="o">$</span><span class="n">lwage</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">-0.0750320051259581</div></div>
</div>
<p>Thus, the unconditional gender wage gap is about <span class="math notranslate nohighlight">\(7,5\)</span>% for the group of never married workers (women get paid less on average in our sample). We also observe that never married working women are relatively more educated than working men and have lower working experience.</p>
<p>This unconditional (predictive) effect of gender equals the coefficient <span class="math notranslate nohighlight">\(\beta\)</span> in the univariate ols regression of <span class="math notranslate nohighlight">\(Y\)</span> on <span class="math notranslate nohighlight">\(D\)</span>:</p>
<div class="math notranslate nohighlight">
\[
\begin{align}
\log(Y) &amp;=\beta D + \epsilon.
\end{align}
\]</div>
<p>We verify this by running an ols regression in R.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#install.packages(&quot;sandwich&quot;)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">sandwich</span><span class="p">)</span>

<span class="n">nocontrol.fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">lwage</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">sex</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="n">nocontrol.est</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="n">nocontrol.fit</span><span class="p">)</span><span class="o">$</span><span class="n">coef</span><span class="p">[</span><span class="s">&quot;sex&quot;</span><span class="p">,</span><span class="m">1</span><span class="p">]</span>
<span class="n">HCV.coefs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">nocontrol.fit</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;HC&#39;</span><span class="p">);</span>
<span class="n">nocontrol.se</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">diag</span><span class="p">(</span><span class="n">HCV.coefs</span><span class="p">))[</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="c1"># Estimated std errors</span>

<span class="c1"># print unconditional effect of gender and the corresponding standard error</span>
<span class="nf">cat </span><span class="p">(</span><span class="s">&quot;The estimated gender coefficient is&quot;</span><span class="p">,</span><span class="n">nocontrol.est</span><span class="p">,</span><span class="s">&quot; and the corresponding robust standard error is&quot;</span><span class="p">,</span><span class="n">nocontrol.se</span><span class="p">)</span><span class="w"> </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The estimated gender coefficient is -0.07503201  and the corresponding robust standard error is 0.0183426
</pre></div>
</div>
</div>
</div>
<p>Note that the standard error is computed with the <em>R</em> package <em>sandwich</em> to be robust to heteroskedasticity.</p>
<p>Next, we run an ols regression of <span class="math notranslate nohighlight">\(Y\)</span> on <span class="math notranslate nohighlight">\((D,W)\)</span> to control for the effect of covariates summarized in <span class="math notranslate nohighlight">\(W\)</span>:</p>
<div class="math notranslate nohighlight">
\[
\begin{align}
\log(Y) &amp;=\beta_1 D  + \beta_2' W + \epsilon.
\end{align}
\]</div>
<p>Here, we are considering the flexible model from the previous lab. Hence, <span class="math notranslate nohighlight">\(W\)</span> controls for experience, education, region, and occupation and industry indicators plus transformations and two-way interactions.</p>
<p>Let us run the ols regression with controls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ols regression with controls</span>

<span class="n">flex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lwage</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">exp1</span><span class="o">+</span><span class="n">exp2</span><span class="o">+</span><span class="n">exp3</span><span class="o">+</span><span class="n">exp4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">shs</span><span class="o">+</span><span class="n">hsg</span><span class="o">+</span><span class="n">scl</span><span class="o">+</span><span class="n">clg</span><span class="o">+</span><span class="n">occ2</span><span class="o">+</span><span class="n">ind2</span><span class="o">+</span><span class="n">mw</span><span class="o">+</span><span class="n">so</span><span class="o">+</span><span class="n">we</span><span class="p">)</span>

<span class="c1">#   Note that ()*() operation in formula objects in R creates a formula of the sort:</span>
<span class="c1">#  (exp1+exp2+exp3+exp4)+ (shs+hsg+scl+clg+occ2+ind2+mw+so+we) +  (exp1+exp2+exp3+exp4)*(shs+hsg+scl+clg+occ2+ind2+mw+so+we)</span>
<span class="c1">#  This is not intuitive at all, but that&#39;s what it does.</span>

<span class="n">control.fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">flex</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">control.est</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="n">control.fit</span><span class="p">)</span><span class="o">$</span><span class="n">coef</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">]</span>

<span class="nf">summary</span><span class="p">(</span><span class="n">control.fit</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Coefficient for OLS with controls&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">control.est</span><span class="p">)</span>

<span class="n">HCV.coefs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">control.fit</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;HC&#39;</span><span class="p">);</span>
<span class="n">control.se</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">diag</span><span class="p">(</span><span class="n">HCV.coefs</span><span class="p">))[</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="c1"># Estimated std errors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Call:
lm(formula = flex, data = data)

Residuals:
     Min       1Q   Median       3Q      Max 
-1.88469 -0.28018 -0.00257  0.27071  2.87358 

Coefficients: (11 not defined because of singularities)
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  3.880838   0.463424   8.374  &lt; 2e-16 ***
sex         -0.067634   0.017476  -3.870 0.000111 ***
exp1        -0.108571   0.182969  -0.593 0.552963    
exp2         2.760461   2.185329   1.263 0.206608    
exp3        -1.557529   0.928441  -1.678 0.093518 .  
exp4         0.245175   0.125503   1.954 0.050834 .  
shs                NA         NA      NA       NA    
hsg                NA         NA      NA       NA    
scl         -0.268071   0.128942  -2.079 0.037689 *  
clg         -0.044201   0.071314  -0.620 0.535423    
occ22        0.148912   0.134319   1.109 0.267660    
occ23        0.151683   0.173250   0.876 0.381353    
occ24        0.024109   0.189196   0.127 0.898608    
occ25       -0.435165   0.197117  -2.208 0.027333 *  
occ26       -0.220077   0.195436  -1.126 0.260207    
occ27        0.283226   0.198407   1.427 0.153525    
occ28       -0.224300   0.174748  -1.284 0.199380    
occ29       -0.331892   0.172040  -1.929 0.053792 .  
occ210       0.009382   0.166232   0.056 0.954997    
occ211      -0.574719   0.340497  -1.688 0.091522 .  
occ212      -0.132992   0.265391  -0.501 0.616320    
occ213      -0.267986   0.251119  -1.067 0.285968    
occ214       0.230008   0.373618   0.616 0.538182    
occ215      -0.172214   0.276890  -0.622 0.534008    
occ216      -0.124377   0.154234  -0.806 0.420058    
occ217      -0.430457   0.144865  -2.971 0.002984 ** 
occ218      -0.186069   2.225178  -0.084 0.933364    
occ219      -0.081721   0.392145  -0.208 0.834932    
occ220      -0.454853   0.259208  -1.755 0.079383 .  
occ221      -0.809969   0.254915  -3.177 0.001499 ** 
occ222      -0.815933   0.360786  -2.262 0.023786 *  
ind23       -1.089541   0.743919  -1.465 0.143120    
ind24        0.044558   0.502874   0.089 0.929399    
ind25       -0.547942   0.471498  -1.162 0.245261    
ind26       -0.718493   0.472438  -1.521 0.128394    
ind27       -0.408055   0.537482  -0.759 0.447785    
ind28       -0.661250   0.515152  -1.284 0.199365    
ind29       -0.756120   0.461846  -1.637 0.101684    
ind210      -0.529993   0.531342  -0.997 0.318608    
ind211      -0.972449   0.482059  -2.017 0.043741 *  
ind212      -0.729268   0.458956  -1.589 0.112156    
ind213      -0.998945   0.516806  -1.933 0.053326 .  
ind214      -0.612478   0.450779  -1.359 0.174325    
ind215      -0.543112   0.631890  -0.860 0.390121    
ind216      -0.553484   0.476666  -1.161 0.245657    
ind217      -0.838034   0.460336  -1.820 0.068770 .  
ind218      -0.791949   0.459071  -1.725 0.084594 .  
ind219      -0.928112   0.490880  -1.891 0.058745 .  
ind220      -0.899239   0.484704  -1.855 0.063646 .  
ind221      -0.777590   0.475908  -1.634 0.102368    
ind222      -0.443536   0.467122  -0.950 0.342427    
mw           0.140500   0.086958   1.616 0.106244    
so           0.026207   0.079301   0.330 0.741058    
we           0.048288   0.088297   0.547 0.584493    
exp1:shs           NA         NA      NA       NA    
exp1:hsg           NA         NA      NA       NA    
exp1:scl    -0.071528   0.044794  -1.597 0.110395    
exp1:clg    -0.052510   0.031659  -1.659 0.097290 .  
exp1:occ22  -0.066435   0.053768  -1.236 0.216692    
exp1:occ23  -0.039714   0.067203  -0.591 0.554593    
exp1:occ24  -0.044148   0.080037  -0.552 0.581264    
exp1:occ25   0.130869   0.090981   1.438 0.150402    
exp1:occ26  -0.036843   0.079519  -0.463 0.643162    
exp1:occ27  -0.217129   0.081806  -2.654 0.007986 ** 
exp1:occ28  -0.043218   0.069581  -0.621 0.534564    
exp1:occ29   0.020649   0.071375   0.289 0.772366    
exp1:occ210  0.014178   0.066700   0.213 0.831675    
exp1:occ211  0.037333   0.126451   0.295 0.767830    
exp1:occ212 -0.055604   0.100191  -0.555 0.578947    
exp1:occ213  0.041249   0.091958   0.449 0.653774    
exp1:occ214 -0.119023   0.133471  -0.892 0.372585    
exp1:occ215 -0.066657   0.103520  -0.644 0.519678    
exp1:occ216 -0.020584   0.058149  -0.354 0.723375    
exp1:occ217  0.021233   0.053788   0.395 0.693043    
exp1:occ218 -0.066422   1.110702  -0.060 0.952317    
exp1:occ219 -0.073559   0.135324  -0.544 0.586763    
exp1:occ220  0.079898   0.090445   0.883 0.377082    
exp1:occ221  0.270508   0.091179   2.967 0.003030 ** 
exp1:occ222  0.077255   0.120728   0.640 0.522271    
exp1:ind23   0.434498   0.300512   1.446 0.148306    
exp1:ind24   0.004614   0.190028   0.024 0.980629    
exp1:ind25   0.178890   0.187530   0.954 0.340186    
exp1:ind26   0.234188   0.185514   1.262 0.206897    
exp1:ind27   0.095699   0.212425   0.451 0.652373    
exp1:ind28   0.223093   0.216341   1.031 0.302512    
exp1:ind29   0.147902   0.181455   0.815 0.415077    
exp1:ind210  0.154391   0.204641   0.754 0.450630    
exp1:ind211  0.329852   0.189314   1.742 0.081533 .  
exp1:ind212  0.287189   0.182027   1.578 0.114717    
exp1:ind213  0.360734   0.197746   1.824 0.068201 .  
exp1:ind214  0.188209   0.178995   1.051 0.293114    
exp1:ind215  0.112956   0.282951   0.399 0.689764    
exp1:ind216  0.104720   0.189077   0.554 0.579716    
exp1:ind217  0.206963   0.182375   1.135 0.256526    
exp1:ind218  0.204515   0.181267   1.128 0.259291    
exp1:ind219  0.199490   0.192716   1.035 0.300669    
exp1:ind220  0.152476   0.189062   0.806 0.420018    
exp1:ind221  0.250721   0.186934   1.341 0.179932    
exp1:ind222  0.163191   0.183004   0.892 0.372597    
exp1:mw     -0.047600   0.035164  -1.354 0.175932    
exp1:so     -0.013572   0.031634  -0.429 0.667917    
exp1:we     -0.036068   0.034310  -1.051 0.293222    
exp2:shs           NA         NA      NA       NA    
exp2:hsg           NA         NA      NA       NA    
exp2:scl     0.687115   0.481881   1.426 0.153985    
exp2:clg     0.402346   0.390598   1.030 0.303044    
exp2:occ22   0.527094   0.609392   0.865 0.387125    
exp2:occ23   0.225955   0.762662   0.296 0.767040    
exp2:occ24   0.609598   0.948693   0.643 0.520547    
exp2:occ25  -1.603297   1.212946  -1.322 0.186313    
exp2:occ26   0.064776   0.949165   0.068 0.945594    
exp2:occ27   3.099522   0.997912   3.106 0.001911 ** 
exp2:occ28   0.260534   0.797301   0.327 0.743861    
exp2:occ29   0.172604   0.829760   0.208 0.835228    
exp2:occ210 -0.349280   0.775901  -0.450 0.652622    
exp2:occ211 -0.145738   1.423343  -0.102 0.918452    
exp2:occ212  0.424348   1.149393   0.369 0.712006    
exp2:occ213 -0.742081   0.992571  -0.748 0.454730    
exp2:occ214  0.265853   1.401494   0.190 0.849561    
exp2:occ215  0.338227   1.128005   0.300 0.764313    
exp2:occ216 -0.001585   0.642063  -0.002 0.998030    
exp2:occ217 -0.353390   0.589074  -0.600 0.548606    
exp2:occ218 -0.038852   9.385632  -0.004 0.996697    
exp2:occ219  0.972485   1.399603   0.695 0.487208    
exp2:occ220 -0.726862   0.934768  -0.778 0.436865    
exp2:occ221 -3.285748   0.977012  -3.363 0.000779 ***
exp2:occ222 -0.456725   1.212919  -0.377 0.706530    
exp2:ind23  -5.824070   3.732976  -1.560 0.118810    
exp2:ind24  -1.889540   2.229469  -0.848 0.396757    
exp2:ind25  -3.397191   2.238534  -1.518 0.129206    
exp2:ind26  -3.761806   2.205929  -1.705 0.088223 .  
exp2:ind27  -2.099423   2.555966  -0.821 0.411484    
exp2:ind28  -3.028965   2.733447  -1.108 0.267889    
exp2:ind29  -2.788142   2.167615  -1.286 0.198432    
exp2:ind210 -2.990458   2.369136  -1.262 0.206939    
exp2:ind211 -4.732148   2.248906  -2.104 0.035431 *  
exp2:ind212 -4.133344   2.180238  -1.896 0.058065 .  
exp2:ind213 -4.917856   2.310394  -2.129 0.033358 *  
exp2:ind214 -3.257135   2.150783  -1.514 0.130015    
exp2:ind215 -2.291289   3.277340  -0.699 0.484516    
exp2:ind216 -2.200558   2.256437  -0.975 0.329510    
exp2:ind217 -3.236968   2.184221  -1.482 0.138435    
exp2:ind218 -3.472941   2.170142  -1.600 0.109615    
exp2:ind219 -3.089987   2.273999  -1.359 0.174286    
exp2:ind220 -2.877686   2.236664  -1.287 0.198319    
exp2:ind221 -3.985898   2.224415  -1.792 0.073237 .  
exp2:ind222 -3.054599   2.178721  -1.402 0.160999    
exp2:mw      0.405157   0.404326   1.002 0.316386    
exp2:so      0.169620   0.359140   0.472 0.636745    
exp2:we      0.566872   0.383896   1.477 0.139864    
exp3:shs           NA         NA      NA       NA    
exp3:hsg           NA         NA      NA       NA    
exp3:scl    -0.225675   0.194444  -1.161 0.245877    
exp3:clg    -0.105850   0.169919  -0.623 0.533362    
exp3:occ22  -0.127358   0.250141  -0.509 0.610682    
exp3:occ23  -0.050120   0.313891  -0.160 0.873148    
exp3:occ24  -0.284498   0.394622  -0.721 0.470995    
exp3:occ25   0.714085   0.554332   1.288 0.197764    
exp3:occ26   0.078209   0.410734   0.190 0.848996    
exp3:occ27  -1.394062   0.438136  -3.182 0.001476 ** 
exp3:occ28  -0.009171   0.328256  -0.028 0.977714    
exp3:occ29  -0.158800   0.345751  -0.459 0.646054    
exp3:occ210  0.233391   0.326016   0.716 0.474107    
exp3:occ211 -0.034816   0.598743  -0.058 0.953634    
exp3:occ212  0.017275   0.479540   0.036 0.971265    
exp3:occ213  0.342360   0.389837   0.878 0.379888    
exp3:occ214  0.144255   0.526802   0.274 0.784230    
exp3:occ215  0.007181   0.451462   0.016 0.987310    
exp3:occ216  0.104163   0.260350   0.400 0.689117    
exp3:occ217  0.188664   0.237170   0.795 0.426388    
exp3:occ218  0.081058   1.827773   0.044 0.964629    
exp3:occ219 -0.430058   0.540351  -0.796 0.426151    
exp3:occ220  0.246731   0.361135   0.683 0.494518    
exp3:occ221  1.334641   0.386355   3.454 0.000558 ***
exp3:occ222  0.126481   0.458203   0.276 0.782535    
exp3:ind23   2.678306   1.724974   1.553 0.120593    
exp3:ind24   1.298272   0.937883   1.384 0.166367    
exp3:ind25   1.760362   0.948790   1.855 0.063626 .  
exp3:ind26   1.868851   0.933498   2.002 0.045362 *  
exp3:ind27   1.174466   1.101602   1.066 0.286431    
exp3:ind28   1.234915   1.248416   0.989 0.322640    
exp3:ind29   1.468577   0.921405   1.594 0.111060    
exp3:ind210  1.575305   0.987705   1.595 0.110821    
exp3:ind211  2.233491   0.952335   2.345 0.019068 *  
exp3:ind212  1.939677   0.927217   2.092 0.036516 *  
exp3:ind213  2.222883   0.968253   2.296 0.021747 *  
exp3:ind214  1.673783   0.916531   1.826 0.067902 .  
exp3:ind215  1.289902   1.319644   0.977 0.328407    
exp3:ind216  1.252572   0.955306   1.311 0.189884    
exp3:ind217  1.595382   0.928153   1.719 0.085724 .  
exp3:ind218  1.762369   0.923761   1.908 0.056495 .  
exp3:ind219  1.526045   0.958381   1.592 0.111403    
exp3:ind220  1.527794   0.943682   1.619 0.105543    
exp3:ind221  1.936016   0.942996   2.053 0.040141 *  
exp3:ind222  1.610296   0.923435   1.744 0.081279 .  
exp3:mw     -0.127201   0.168242  -0.756 0.449664    
exp3:so     -0.063505   0.147260  -0.431 0.666318    
exp3:we     -0.253221   0.155667  -1.627 0.103893    
exp4:shs           NA         NA      NA       NA    
exp4:hsg           NA         NA      NA       NA    
exp4:scl     0.024112   0.025867   0.932 0.351324    
exp4:clg     0.008900   0.023652   0.376 0.706728    
exp4:occ22   0.005612   0.033502   0.168 0.866982    
exp4:occ23   0.003462   0.041930   0.083 0.934193    
exp4:occ24   0.037319   0.052491   0.711 0.477148    
exp4:occ25  -0.102265   0.080051  -1.277 0.201511    
exp4:occ26  -0.021559   0.057425  -0.375 0.707360    
exp4:occ27   0.191216   0.061456   3.111 0.001877 ** 
exp4:occ28  -0.009269   0.043780  -0.212 0.832338    
exp4:occ29   0.027119   0.046596   0.582 0.560597    
exp4:occ210 -0.042185   0.044457  -0.949 0.342732    
exp4:occ211  0.013254   0.082312   0.161 0.872089    
exp4:occ212 -0.030339   0.065220  -0.465 0.641828    
exp4:occ213 -0.049296   0.049838  -0.989 0.322675    
exp4:occ214 -0.040130   0.064519  -0.622 0.533992    
exp4:occ215 -0.015901   0.059245  -0.268 0.788415    
exp4:occ216 -0.026793   0.034541  -0.776 0.437990    
exp4:occ217 -0.030840   0.031263  -0.986 0.323972    
exp4:occ218        NA         NA      NA       NA    
exp4:occ219  0.056633   0.068595   0.826 0.409075    
exp4:occ220 -0.029161   0.046086  -0.633 0.526935    
exp4:occ221 -0.173879   0.050263  -3.459 0.000548 ***
exp4:occ222 -0.015582   0.057468  -0.271 0.786293    
exp4:ind23  -0.390159   0.263692  -1.480 0.139069    
exp4:ind24  -0.218162   0.125715  -1.735 0.082764 .  
exp4:ind25  -0.263027   0.128018  -2.055 0.039990 *  
exp4:ind26  -0.274877   0.125734  -2.186 0.028868 *  
exp4:ind27  -0.181914   0.151703  -1.199 0.230553    
exp4:ind28  -0.149228   0.183833  -0.812 0.416987    
exp4:ind29  -0.222289   0.124579  -1.784 0.074458 .  
exp4:ind210 -0.237585   0.132035  -1.799 0.072039 .  
exp4:ind211 -0.322195   0.128532  -2.507 0.012230 *  
exp4:ind212 -0.277952   0.125403  -2.216 0.026723 *  
exp4:ind213 -0.311492   0.129616  -2.403 0.016304 *  
exp4:ind214 -0.250871   0.124081  -2.022 0.043268 *  
exp4:ind215 -0.204839   0.170066  -1.204 0.228488    
exp4:ind216 -0.199306   0.128748  -1.548 0.121703    
exp4:ind217 -0.234727   0.125392  -1.872 0.061297 .  
exp4:ind218 -0.262904   0.125149  -2.101 0.035735 *  
exp4:ind219 -0.224314   0.128925  -1.740 0.081968 .  
exp4:ind220 -0.235229   0.126946  -1.853 0.063968 .  
exp4:ind221 -0.281403   0.127276  -2.211 0.027102 *  
exp4:ind222 -0.246069   0.124575  -1.975 0.048315 *  
exp4:mw      0.012197   0.022784   0.535 0.592452    
exp4:so      0.006360   0.019596   0.325 0.745551    
exp4:we      0.033250   0.020541   1.619 0.105598    
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 0.4726 on 3539 degrees of freedom
Multiple R-squared:  0.3447,	Adjusted R-squared:  0.3013 
F-statistic: 7.954 on 234 and 3539 DF,  p-value: &lt; 2.2e-16
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coefficient for OLS with controls -0.0676339
</pre></div>
</div>
</div>
</div>
<p>The estimated regression coefficient <span class="math notranslate nohighlight">\(\beta_1\approx-0.0676\)</span> measures how our linear prediction of wage changes if we set the gender variable <span class="math notranslate nohighlight">\(D\)</span> from 0 to 1, holding the controls <span class="math notranslate nohighlight">\(W\)</span> fixed.
We can call this the <em>predictive effect</em> (PE), as it measures the impact of a variable on the prediction we make. Overall, we see that the unconditional wage gap of size <span class="math notranslate nohighlight">\(4\)</span>% for women increases to about <span class="math notranslate nohighlight">\(7\)</span>% after controlling for worker characteristics.</p>
<p>Next, we are using the Frisch-Waugh-Lovell theorem from the lecture partialling-out the linear effect of the controls via ols.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Partialling-Out using ols</span>

<span class="c1"># models</span>
<span class="n">flex.y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lwage</span><span class="w"> </span><span class="o">~</span><span class="w">  </span><span class="p">(</span><span class="n">exp1</span><span class="o">+</span><span class="n">exp2</span><span class="o">+</span><span class="n">exp3</span><span class="o">+</span><span class="n">exp4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">shs</span><span class="o">+</span><span class="n">hsg</span><span class="o">+</span><span class="n">scl</span><span class="o">+</span><span class="n">clg</span><span class="o">+</span><span class="n">occ2</span><span class="o">+</span><span class="n">ind2</span><span class="o">+</span><span class="n">mw</span><span class="o">+</span><span class="n">so</span><span class="o">+</span><span class="n">we</span><span class="p">)</span><span class="w"> </span><span class="c1"># model for Y</span>
<span class="n">flex.d</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="p">(</span><span class="n">exp1</span><span class="o">+</span><span class="n">exp2</span><span class="o">+</span><span class="n">exp3</span><span class="o">+</span><span class="n">exp4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">shs</span><span class="o">+</span><span class="n">hsg</span><span class="o">+</span><span class="n">scl</span><span class="o">+</span><span class="n">clg</span><span class="o">+</span><span class="n">occ2</span><span class="o">+</span><span class="n">ind2</span><span class="o">+</span><span class="n">mw</span><span class="o">+</span><span class="n">so</span><span class="o">+</span><span class="n">we</span><span class="p">)</span><span class="w"> </span><span class="c1"># model for D</span>

<span class="c1"># partialling-out the linear effect of W from Y</span>
<span class="n">t.Y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">flex.y</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">$</span><span class="n">res</span>
<span class="c1"># partialling-out the linear effect of W from D</span>
<span class="n">t.D</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">flex.d</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">$</span><span class="n">res</span>

<span class="c1"># regression of Y on D after partialling-out the effect of W</span>
<span class="n">partial.fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">t.Y</span><span class="o">~</span><span class="n">t.D</span><span class="p">)</span>
<span class="n">partial.est</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="n">partial.fit</span><span class="p">)</span><span class="o">$</span><span class="n">coef</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">]</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Coefficient for D via partialling-out&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">partial.est</span><span class="p">)</span>

<span class="c1"># standard error</span>
<span class="n">HCV.coefs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">partial.fit</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;HC&#39;</span><span class="p">)</span>
<span class="n">partial.se</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">diag</span><span class="p">(</span><span class="n">HCV.coefs</span><span class="p">))[</span><span class="m">2</span><span class="p">]</span>

<span class="c1"># confidence interval</span>
<span class="nf">confint</span><span class="p">(</span><span class="n">partial.fit</span><span class="p">)[</span><span class="m">2</span><span class="p">,]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coefficient for D via partialling-out -0.0676339
</pre></div>
</div>
<div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>2.5 %</dt><dd>-0.100823033855121</dd><dt>97.5 %</dt><dd>-0.0344447624332549</dd></dl>
</div></div>
</div>
<p>Again, the estimated coefficient measures the linear predictive effect (PE) of <span class="math notranslate nohighlight">\(D\)</span> on <span class="math notranslate nohighlight">\(Y\)</span> after taking out the linear effect of <span class="math notranslate nohighlight">\(W\)</span> on both of these variables. This coefficient equals the estimated coefficient from the ols regression with controls.</p>
<p>We know that the partialling-out approach works well when the dimension of <span class="math notranslate nohighlight">\(W\)</span> is low
in relation to the sample size <span class="math notranslate nohighlight">\(n\)</span>. When the dimension of <span class="math notranslate nohighlight">\(W\)</span> is relatively high, we need to use variable selection
or penalization for regularization purposes.</p>
<p>In the following, we illustrate the partialling-out approach using lasso instead of ols.</p>
<p>Next, we summarize the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="n">table</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">]</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nocontrol.est</span><span class="w">  </span>
<span class="n">table</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">]</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nocontrol.se</span><span class="w">   </span>
<span class="n">table</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">]</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">control.est</span>
<span class="n">table</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">]</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">control.se</span><span class="w">    </span>
<span class="n">table</span><span class="p">[</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">]</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partial.est</span><span class="w">  </span>
<span class="n">table</span><span class="p">[</span><span class="m">3</span><span class="p">,</span><span class="m">2</span><span class="p">]</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partial.se</span><span class="w">  </span>

<span class="nf">colnames</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Estimate&quot;</span><span class="p">,</span><span class="s">&quot;Std. Error&quot;</span><span class="p">)</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Without controls&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;full reg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;partial reg&quot;</span><span class="p">)</span><span class="w">	</span>
<span class="n">tab</span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">xtable</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">digits</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">))</span>
<span class="n">tab</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A xtable: 3 × 2</caption>
<thead>
	<tr><th></th><th scope=col>Estimate</th><th scope=col>Std. Error</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>Without controls</th><td>-0.07503201</td><td>0.01834260</td></tr>
	<tr><th scope=row>full reg</th><td>-0.06763390</td><td>0.01676536</td></tr>
	<tr><th scope=row>partial reg</th><td>-0.06763390</td><td>0.01676536</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s">&quot;html&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;!-- html table generated in R 4.3.3 by xtable 1.8-4 package --&gt;
&lt;!-- Sat Jul 20 15:07:58 2024 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt;  &lt;/th&gt; &lt;th&gt; Estimate &lt;/th&gt; &lt;th&gt; Std. Error &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; Without controls &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; -0.075 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.0183 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; full reg &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; -0.068 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.0168 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; partial reg &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; -0.068 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 0.0168 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
</pre></div>
</div>
</div>
</div>
<!-- html table generated in R 4.3.3 by xtable 1.8-4 package -->
<!-- Sat Apr 13 20:58:46 2024 -->
<table border=1>
<tr> <th>  </th> <th> Estimate </th> <th> Std. Error </th>  </tr>
  <tr> <td align="right"> Without controls </td> <td align="right"> -0.075 </td> <td align="right"> 0.0183 </td> </tr>
  <tr> <td align="right"> full reg </td> <td align="right"> -0.068 </td> <td align="right"> 0.0168 </td> </tr>
  <tr> <td align="right"> partial reg </td> <td align="right"> -0.068 </td> <td align="right"> 0.0168 </td> </tr>
   </table><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">##################################################COEF PLOT</span>
<span class="nf">library</span><span class="p">(</span><span class="n">coefplot</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">gridExtra</span><span class="p">)</span>
<span class="n">flex.y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lwage</span><span class="w"> </span><span class="o">~</span><span class="w">  </span><span class="p">(</span><span class="n">exp1</span><span class="o">+</span><span class="n">exp2</span><span class="o">+</span><span class="n">exp3</span><span class="o">+</span><span class="n">exp4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">scl</span><span class="o">+</span><span class="n">clg</span><span class="o">+</span><span class="n">ad</span><span class="o">+</span><span class="n">occ2</span><span class="o">+</span><span class="n">ind2</span><span class="o">+</span><span class="n">mw</span><span class="o">+</span><span class="n">so</span><span class="o">+</span><span class="n">we</span><span class="p">)</span><span class="w"> </span><span class="c1"># model for Y</span>
<span class="n">flex.d</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="p">(</span><span class="n">exp1</span><span class="o">+</span><span class="n">exp2</span><span class="o">+</span><span class="n">exp3</span><span class="o">+</span><span class="n">exp4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">scl</span><span class="o">+</span><span class="n">clg</span><span class="o">+</span><span class="n">ad</span><span class="o">+</span><span class="n">occ2</span><span class="o">+</span><span class="n">ind2</span><span class="o">+</span><span class="n">mw</span><span class="o">+</span><span class="n">so</span><span class="o">+</span><span class="n">we</span><span class="p">)</span><span class="w"> </span><span class="c1"># model for D</span>
<span class="c1"># partialling-out the linear effect of W from Y</span>
<span class="n">t.Y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">flex.y</span><span class="p">,</span><span class="w"> </span><span class="n">data1</span><span class="o">=</span><span class="n">data1</span><span class="p">)</span><span class="o">$</span><span class="n">res</span>
<span class="c1"># partialling-out the linear effect of W from D</span>
<span class="n">t.D</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">flex.d</span><span class="p">,</span><span class="w"> </span><span class="n">data1</span><span class="o">=</span><span class="n">data1</span><span class="p">)</span><span class="o">$</span><span class="n">res</span>

<span class="c1"># Ajustar los modelos</span>
<span class="n">nocontrol.fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">lwage</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">sex</span><span class="p">)</span>
<span class="n">control.fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">lwage</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">exp1</span><span class="o">+</span><span class="n">exp2</span><span class="o">+</span><span class="n">exp3</span><span class="o">+</span><span class="n">exp4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">scl</span><span class="o">+</span><span class="n">clg</span><span class="o">+</span><span class="n">ad</span><span class="o">+</span><span class="n">occ2</span><span class="o">+</span><span class="n">ind2</span><span class="o">+</span><span class="n">mw</span><span class="o">+</span><span class="n">so</span><span class="o">+</span><span class="n">we</span><span class="p">))</span>
<span class="n">partial.fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">t.Y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">t.D</span><span class="p">)</span>



<span class="c1"># Graficar los coeficientes estimados con límites en el eje x ajustados</span>
<span class="n">plot_nocontrol</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">coefplot</span><span class="p">(</span><span class="n">nocontrol.fit</span><span class="p">,</span><span class="w"> </span><span class="n">coefficients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;sex&quot;</span><span class="p">)</span><span class="o">+</span><span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;No Controls&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">xlim</span><span class="p">(</span><span class="m">-0.15</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="n">plot_control</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">coefplot</span><span class="p">(</span><span class="n">control.fit</span><span class="p">,</span><span class="w"> </span><span class="n">coefficients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;sex&quot;</span><span class="p">)</span><span class="o">+</span><span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Controls&quot;</span><span class="p">)</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="nf">xlim</span><span class="p">(</span><span class="m">-0.15</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="n">plot_partial</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">coefplot</span><span class="p">(</span><span class="n">partial.fit</span><span class="p">,</span><span class="w"> </span><span class="n">coefficients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;t.D&quot;</span><span class="p">)</span><span class="o">+</span><span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Partialling out&quot;</span><span class="p">)</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="nf">xlim</span><span class="p">(</span><span class="m">-0.15</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>

<span class="c1"># Unir los gráficos verticalmente</span>
<span class="n">combined_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">grid.arrange</span><span class="p">(</span><span class="n">plot_nocontrol</span><span class="p">,</span><span class="w"> </span><span class="n">plot_control</span><span class="p">,</span><span class="w"> </span><span class="n">plot_partial</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attaching package: &#39;gridExtra&#39;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following object is masked from &#39;package:dplyr&#39;:

    combine
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
&quot;In lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) :
 extra argument &#39;data1&#39; will be disregarded&quot;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
&quot;In lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) :
 extra argument &#39;data1&#39; will be disregarded&quot;
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/c91300f39c0fefeb0a1df4aadc5dc94f06b9a2d6bf3afd840c24245c249ce693.png"><img alt="../../_images/c91300f39c0fefeb0a1df4aadc5dc94f06b9a2d6bf3afd840c24245c249ce693.png" src="../../_images/c91300f39c0fefeb0a1df4aadc5dc94f06b9a2d6bf3afd840c24245c249ce693.png" style="width: 420px; height: 420px;" /></a>
</div>
</div>
<p>The coefficient associated with the gender variable, which indicates the prediction of being female on salary, is initially negative. This suggests that, on average, women have lower salaries than men. However, after adding these controls, such as work experience or educational level, the negative coefficient associated with the gender variable becomes  less negative.</p>
<p>This change in the gender coefficient could be explained by the fact that the control variables are capturing some of the variability in salaries that was previously incorrectly attributed to gender. This suggests that additional factors, beyond gender, are influencing salaries, and the impact of gender on salaries is less pronounced once these other variables are taken into account. Besides, both FWL and including control  variables in the regression model yield coefficient estimates for the variable of interest that reflect its net impact on the dependent variable, once the effects of other explanatory variables have been taken into account.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generar valores de exp4 para predecir las medias de lwage con más puntos</span>
<span class="n">exp4_seq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">exp4</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">exp4</span><span class="p">),</span><span class="w"> </span><span class="n">length.out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">)</span>

<span class="c1"># Ajustar el modelo LOESS </span>
<span class="n">loess_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">loess</span><span class="p">(</span><span class="n">lwage</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="p">(</span><span class="n">exp4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sex</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">)</span>

<span class="c1"># Crear un nuevo data frame con los valores de exp4 para predecir</span>
<span class="n">new_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">exp4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp4_seq</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>

<span class="c1"># Predecir las medias de lwage utilizando el modelo loess</span>
<span class="n">lwage_mean_pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">loess_model</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_data</span><span class="p">)</span>

<span class="c1"># Calcula la media de lwage para cada valor único de exp4 solo para mujeres</span>
<span class="n">mean_lwage_women</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">tapply</span><span class="p">(</span><span class="nf">subset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="o">$</span><span class="n">lwage</span><span class="p">,</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="o">$</span><span class="n">exp4</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span>

<span class="c1"># Graficar ambas relaciones en un solo gráfico</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">exp4_seq</span><span class="p">,</span><span class="w"> </span><span class="n">lwage_mean_pred</span><span class="p">,</span>
<span class="w">     </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># Tipo de gráfico: línea</span>
<span class="w">     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># Color de la línea para el modelo LOESS</span>
<span class="w">     </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w">     </span><span class="c1"># Grosor de la línea para el modelo LOESS</span>
<span class="w">     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;exp4&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mean lwage&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mean lwage vs exp4 with Loess Smoothing and Mean lwage vs exp4 (Women only)&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">40</span><span class="p">),</span><span class="w">  </span><span class="c1"># Limitar los valores en el eje x de 0 a 40</span>
<span class="w">     </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2.6</span><span class="p">,</span><span class="w"> </span><span class="m">3.4</span><span class="p">))</span><span class="w">   </span><span class="c1"># Ajustar la escala del eje y de 2 a 4</span>
<span class="nf">lines</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">mean_lwage_women</span><span class="p">)),</span><span class="w"> </span><span class="n">mean_lwage_women</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">  </span><span class="c1"># Agregar la relación de media de lwage vs exp4</span>
<span class="nf">legend</span><span class="p">(</span><span class="s">&quot;topright&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Loess Smoothing&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Mean lwage (Women only)&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, :
&quot;pseudoinverse used at -0.10036 -0.010002&quot;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, :
&quot;neighborhood radius 4.8847&quot;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, :
&quot;reciprocal condition number  2.6408e-15&quot;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, :
&quot;There are other near singularities as well. 410.95&quot;
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/abb36717f59e276e2c5fbf8fd8a7934ea454802d69424b2c234711f86ca969c4.png"><img alt="../../_images/abb36717f59e276e2c5fbf8fd8a7934ea454802d69424b2c234711f86ca969c4.png" src="../../_images/abb36717f59e276e2c5fbf8fd8a7934ea454802d69424b2c234711f86ca969c4.png" style="width: 420px; height: 420px;" /></a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generar valores de exp4 para predecir las medias de lwage con más puntos</span>
<span class="n">exp4_seq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">exp4</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">exp4</span><span class="p">),</span><span class="w"> </span><span class="n">length.out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">)</span>

<span class="c1"># Ajustar el modelo LOESS </span>
<span class="n">loess_model_men</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">loess</span><span class="p">(</span><span class="n">lwage</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="p">(</span><span class="n">exp4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sex</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">)</span>

<span class="c1"># Crear un nuevo data frame con los valores de exp4 para predecir</span>
<span class="n">new_data_men</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">exp4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp4_seq</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">  </span><span class="c1"># Solo varones</span>

<span class="c1"># Predecir las medias de lwage utilizando el modelo loess para varones</span>
<span class="n">lwage_mean_pred_men</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">loess_model_men</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_data_men</span><span class="p">)</span>

<span class="c1"># Calcula la media de lwage para cada valor único de exp4 solo para varones</span>
<span class="n">mean_lwage_men</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">tapply</span><span class="p">(</span><span class="nf">subset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="o">$</span><span class="n">lwage</span><span class="p">,</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="o">$</span><span class="n">exp4</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span>

<span class="c1"># Graficar ambas relaciones en un solo gráfico</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">exp4_seq</span><span class="p">,</span><span class="w"> </span><span class="n">lwage_mean_pred_men</span><span class="p">,</span>
<span class="w">     </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># Tipo de gráfico: línea</span>
<span class="w">     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># Color de la línea para el modelo LOESS</span>
<span class="w">     </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w">     </span><span class="c1"># Grosor de la línea para el modelo LOESS</span>
<span class="w">     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;exp4&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mean lwage&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mean lwage vs exp4 with Loess Smoothing and Mean lwage vs exp4 (Men only)&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">40</span><span class="p">),</span><span class="w">  </span><span class="c1"># Limitar los valores en el eje x de 0 a 40</span>
<span class="w">     </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2.6</span><span class="p">,</span><span class="w"> </span><span class="m">3.4</span><span class="p">))</span><span class="w">   </span><span class="c1"># Ajustar la escala del eje y de 2 a 4</span>
<span class="nf">lines</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">mean_lwage_men</span><span class="p">)),</span><span class="w"> </span><span class="n">mean_lwage_men</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">  </span><span class="c1"># Agregar la relación de media de lwage vs exp4 para varones</span>
<span class="nf">legend</span><span class="p">(</span><span class="s">&quot;topright&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Loess Smoothing&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Mean lwage (Men only)&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, :
&quot;pseudoinverse used at -0.10036 -0.010002&quot;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, :
&quot;neighborhood radius 4.8847&quot;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, :
&quot;reciprocal condition number  2.6408e-15&quot;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, :
&quot;There are other near singularities as well. 410.95&quot;
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/2372a364926110937006fe503e0473bfb14d2eee01118ab048b8d8eed83447e1.png"><img alt="../../_images/2372a364926110937006fe503e0473bfb14d2eee01118ab048b8d8eed83447e1.png" src="../../_images/2372a364926110937006fe503e0473bfb14d2eee01118ab048b8d8eed83447e1.png" style="width: 420px; height: 420px;" /></a>
</div>
</div>
<p>Next we try “extra” flexible model, where we take interactions of all controls, giving us about 1000 controls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">extraflex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lwage</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">exp1</span><span class="o">+</span><span class="n">exp2</span><span class="o">+</span><span class="n">exp3</span><span class="o">+</span><span class="n">exp4</span><span class="o">+</span><span class="n">shs</span><span class="o">+</span><span class="n">hsg</span><span class="o">+</span><span class="n">scl</span><span class="o">+</span><span class="n">clg</span><span class="o">+</span><span class="n">occ2</span><span class="o">+</span><span class="n">ind2</span><span class="o">+</span><span class="n">mw</span><span class="o">+</span><span class="n">so</span><span class="o">+</span><span class="n">we</span><span class="p">)</span><span class="o">^</span><span class="m">2</span>

<span class="n">control.fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">extraflex</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="c1">#summary(control.fit)</span>
<span class="n">control.est</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="n">control.fit</span><span class="p">)</span><span class="o">$</span><span class="n">coef</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">]</span>


<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Number of Extra-Flex Controls&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">control.fit</span><span class="o">$</span><span class="n">coef</span><span class="p">)</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>


<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Coefficient for OLS with extra flex controls&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">control.est</span><span class="p">)</span>


<span class="c1">#summary(control.fit)</span>



<span class="n">HCV.coefs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">control.fit</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;HC&#39;</span><span class="p">);</span>

<span class="n">n</span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">wage</span><span class="p">);</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">control.fit</span><span class="o">$</span><span class="n">coef</span><span class="p">);</span>

<span class="n">control.se</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">diag</span><span class="p">(</span><span class="n">HCV.coefs</span><span class="p">))[</span><span class="m">2</span><span class="p">]</span><span class="o">*</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="c1"># Estimated std errors</span>

<span class="c1"># crude adjustment for the effect of dimensionality on OLS standard errors, motivated by Cattaneo, Jannson, and Newey (2018)</span>

<span class="c1"># for really correct way of doing this, we need to implement Cattaneo, Jannson, and Newey (2018)&#39;s procedure.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of Extra-Flex Controls 979 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coefficient for OLS with extra flex controls -0.05950266
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="cross-validation-in-lasso-regression-manual-implementation-task">
<h2><strong>Cross-Validation in Lasso Regression - Manual Implementation Task</strong><a class="headerlink" href="#cross-validation-in-lasso-regression-manual-implementation-task" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;ggplot2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
&quot;package &#39;ggplot2&#39; is in use and will not be installed&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">caret</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: lattice
</pre></div>
</div>
</div>
</div>
<p><strong>1. Data Preparation</strong></p>
<p>Load the March Supplement of the U.S. Current Population Survey, year 2015. (wage2015_subsample_inference.Rdata)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">load</span><span class="p">(</span><span class="s">&quot;..\..\data\wage2015_subsample_inference.csv&quot;</span><span class="p">)</span>

<span class="c1"># Print a summary of the data frame</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&quot;Summary of the data:&quot;</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Print dimensions of the data frame</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&quot;Dimensions of the data:&quot;</span><span class="p">)</span>
<span class="nf">dim</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="nn">Error: &#39;\.&#39; is an unrecognized escape</span> in <span class="ni">character string </span><span class="nt">(&lt;text&gt;:1:10)</span>
<span class="ne">Traceback</span>:
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">flex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lwage</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hsg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">clg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">occ2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ind2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mw</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="p">(</span><span class="n">exp1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">exp2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">exp3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">exp4</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">shs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hsg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">clg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">occ2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ind2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mw</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">we</span><span class="p">)</span>

<span class="c1"># Fit the model using lm() function for OLS regression</span>
<span class="n">flex_results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">flex</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="nf">summary</span><span class="p">(</span><span class="n">flex_results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get exogenous variables from the flexible model</span>
<span class="n">X</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">model.matrix</span><span class="p">(</span><span class="n">flex_results</span><span class="p">)</span>

<span class="c1"># Set endogenous variable</span>
<span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="o">$</span><span class="n">lwage</span><span class="w">  </span><span class="c1"># Directly from the data frame</span>

<span class="c1"># Alternatively, extracting response variable from the model object</span>
<span class="n">y_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">model.response</span><span class="p">(</span><span class="nf">model.frame</span><span class="p">(</span><span class="n">flex_results</span><span class="p">))</span>

<span class="c1"># Verify the contents</span>
<span class="nf">head</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w">  </span><span class="c1"># Shows the first few rows of the model matrix</span>
<span class="nf">head</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w">  </span><span class="c1"># Shows the first few values of the response variable</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set.seed</span><span class="p">(</span><span class="m">24</span><span class="p">)</span><span class="w">  </span><span class="c1"># For reproducibility</span>

<span class="c1"># Calculate the number of observations to split on</span>
<span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">train_size</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="m">0.8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Randomly sample indices for the training data</span>
<span class="n">train_indices</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="nf">seq_len</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">train_size</span><span class="p">)</span>

<span class="c1"># Create training and test datasets</span>
<span class="n">X_train</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">X</span><span class="p">[</span><span class="n">train_indices</span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">drop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">]</span>
<span class="n">X_test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="n">train_indices</span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">drop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">]</span>
<span class="n">y_train</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">train_indices</span><span class="p">]</span>
<span class="n">y_test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">train_indices</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the mean and standard deviation from the training set</span>
<span class="n">train_mean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span>
<span class="n">train_sd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="p">)</span>

<span class="c1"># Standardize the training data</span>
<span class="n">X_train_scaled</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sweep</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">train_mean</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="p">)</span>
<span class="n">X_train_scaled</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sweep</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">train_sd</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)</span>

<span class="c1"># Standardize the test data using the same mean and standard deviation as calculated from the training set</span>
<span class="n">X_test_scaled</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sweep</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">train_mean</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="p">)</span>
<span class="n">X_test_scaled</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sweep</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">train_sd</span><span class="p">,</span><span class="w"> </span><span class="n">FUN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">)</span>

<span class="c1"># Check the results of scaling</span>
<span class="nf">head</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>2. Define a Range of Alpha (Lambda in our equation) Values</strong></p>
<p>We create a list or array of alpha values to iterate over. These will be the different regularization parameters we test. We started testing from 0.1 to 0.5 and found that the MSE in cross-validation was reducing when the alpha value was incrementing. Therefore, we tried with higher values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">alphas</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>3. Partition the Dataset for k-Fold Cross-Validation</strong></p>
<p>We divide the dataset into 5 subsets (or folds). Since we are working with a regression task (predicting the log of wage), we use the K-Fold cross-validator from sklearn. We ensure the data is shuffled by adding ‘shuffle=True’ and set a random state for a reproducible output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set.seed</span><span class="p">(</span><span class="m">24</span><span class="p">)</span><span class="w">  </span><span class="c1"># Set the random seed for reproducibility</span>

<span class="c1"># Create a K-fold cross-validation object</span>
<span class="n">kf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">createFolds</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">returnTrain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>4. Lasso Regression Implementation</strong></p>
<p>Implement a function to fit a Lasso Regression model given a training dataset and an alpha value. The function should return the model’s coefficients and intercept.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lasso_regression</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="w"> </span><span class="n">y_train</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">iterations</span><span class="o">=</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">learning_rate</span><span class="o">=</span><span class="m">0.01</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1"># Get the dimensions of the training data</span>
<span class="w">  </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">nrow</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="w">  </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ncol</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Initialize weights (coefficients) and bias (intercept)</span>
<span class="w">  </span><span class="n">W</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">  </span><span class="c1"># Coefficients</span>
<span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">                                </span><span class="c1"># Intercept</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Perform gradient descent</span>
<span class="w">  </span><span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">iterations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Y_pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">X_train</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="c1"># Predicted values</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">dW</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">  </span><span class="c1"># Initialize gradient of weights</span>
<span class="w">    </span><span class="nf">for </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nf">if </span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dW</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="m">-2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">X_train</span><span class="p">[,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Y_pred</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">alpha</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">m</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="n">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dW</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="m">-2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">X_train</span><span class="p">[,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Y_pred</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">alpha</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">m</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">db</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">-2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Y_pred</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">m</span><span class="w">  </span><span class="c1"># Gradient of bias</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Update weights and bias using gradient descent</span>
<span class="w">    </span><span class="n">W</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">learning_rate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dW</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">learning_rate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">db</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Return weights (coefficients) and bias (intercept)</span>
<span class="w">  </span><span class="nf">return</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p><strong>5. Cross-Validation Loop and 6. Selection of Optimal Alpha</strong></p>
<p>We immplement a for loop to fit the lasso regression. Also, we find the best value of alpha that reduces the average MSE for each fold.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cross-validation function to calculate average MSE for given alpha values</span>
<span class="n">cross_validate_lasso</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="w"> </span><span class="n">y_train</span><span class="p">,</span><span class="w"> </span><span class="n">alphas</span><span class="p">,</span><span class="w"> </span><span class="n">kf</span><span class="p">,</span><span class="w"> </span><span class="n">iterations</span><span class="o">=</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">learning_rate</span><span class="o">=</span><span class="m">0.01</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">avg_mse_values</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">numeric</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">alphas</span><span class="p">))</span>
<span class="w">  </span><span class="n">min_avg_mse</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">Inf</span>
<span class="w">  </span><span class="n">best_alpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span>
<span class="w">  </span>
<span class="w">  </span><span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">alphas</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">alpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">alphas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="n">mse_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">numeric</span><span class="p">(</span><span class="n">kf</span><span class="o">$</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">for </span><span class="p">(</span><span class="n">fold</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">kf</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">train_index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">kf</span><span class="o">$</span><span class="n">inFold</span><span class="p">[[</span><span class="n">fold</span><span class="p">]]</span>
<span class="w">      </span><span class="n">val_index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">kf</span><span class="o">$</span><span class="n">outFold</span><span class="p">[[</span><span class="n">fold</span><span class="p">]]</span>
<span class="w">      </span>
<span class="w">      </span><span class="n">X_train_fold</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">X_train</span><span class="p">[</span><span class="n">train_index</span><span class="p">,</span><span class="w"> </span><span class="p">]</span>
<span class="w">      </span><span class="n">X_val_fold</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">X_train</span><span class="p">[</span><span class="n">val_index</span><span class="p">,</span><span class="w"> </span><span class="p">]</span>
<span class="w">      </span><span class="n">y_train_fold</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y_train</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
<span class="w">      </span><span class="n">y_val_fold</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y_train</span><span class="p">[</span><span class="n">val_index</span><span class="p">]</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Train Lasso regression model with the current alpha</span>
<span class="w">      </span><span class="n">model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lasso_regression</span><span class="p">(</span><span class="n">X_train_fold</span><span class="p">,</span><span class="w"> </span><span class="n">y_train_fold</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">iterations</span><span class="p">,</span><span class="w"> </span><span class="n">learning_rate</span><span class="p">)</span>
<span class="w">      </span><span class="n">W</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">model</span><span class="o">$</span><span class="n">W</span>
<span class="w">      </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">model</span><span class="o">$</span><span class="n">b</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Make predictions on validation set</span>
<span class="w">      </span><span class="n">y_pred_val</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">X_val_fold</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Calculate MSE for this fold</span>
<span class="w">      </span><span class="n">mse_fold</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">mean</span><span class="p">((</span><span class="n">y_val_fold</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y_pred_val</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
<span class="w">      </span><span class="n">mse_list</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mse_fold</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Calculate average MSE across all folds</span>
<span class="w">    </span><span class="n">avg_mse</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">mse_list</span><span class="p">)</span>
<span class="w">    </span><span class="n">avg_mse_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">avg_mse</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;Alpha=%.1f, Average MSE: %.5f\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">avg_mse</span><span class="p">))</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Update best alpha and minimum average MSE</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">avg_mse</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">min_avg_mse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">min_avg_mse</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">avg_mse</span>
<span class="w">      </span><span class="n">best_alpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">alpha</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;Best Alpha: %.1f, Minimum Average MSE: %.5f\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">best_alpha</span><span class="p">,</span><span class="w"> </span><span class="n">min_avg_mse</span><span class="p">))</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Plotting the cross-validated MSE for each alpha value</span>
<span class="w">  </span><span class="nf">plot</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span><span class="w"> </span><span class="n">avg_mse_values</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;o&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Alpha&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Average MSE&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cross-Validated MSE for Different Alpha Values&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">alphas</span><span class="p">),</span><span class="w"> </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">avg_mse_values</span><span class="p">),</span>
<span class="w">       </span><span class="n">xaxt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nf">axis</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alphas</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alphas</span><span class="p">)</span>
<span class="w">  </span><span class="nf">grid</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1"># Perform cross-validated Lasso regression</span>
<span class="nf">cross_validate_lasso</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="w"> </span><span class="n">y_train</span><span class="p">,</span><span class="w"> </span><span class="n">alphas</span><span class="p">,</span><span class="w"> </span><span class="n">kf</span><span class="p">,</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">learning_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.01</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>7. Model Training and Evaluation</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make predictions on test data</span>
<span class="n">y_pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">X_test</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lasso_corr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">cor</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="p">)</span>
<span class="n">lasso_mae</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y_pred</span><span class="p">))</span>
<span class="n">lasso_mse</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">mean</span><span class="p">((</span><span class="n">y_test</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y_pred</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>

<span class="c1"># Print results</span>
<span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;Correlation: %.4f\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lasso_corr</span><span class="p">))</span>
<span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;MAE: %.4f\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lasso_mae</span><span class="p">))</span>
<span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;MSE: %.4f\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lasso_mse</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p><strong>8. Report Results</strong></p>
<p>We began by selecting the parameters for a flexible model, one that includes interactions. After selecting the parameters, we found that the alpha value that produced the lowest mean squared error (MSE) in cross-validation was 60. We then trained the model using all the available training data with the best alpha value. Using the fitted betas, we predicted the lwage using the test X vector. The resulting MSE in the test data was 0.3569, which was lower than in the training data (which was 0.41906). This indicates that the model is not overfitting and that we have found a good correlation score (R square) of 50%.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            name: "ir",
            path: "./labs\lab_1"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="group3_lab1_python.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lab 1 - Python Code</p>
      </div>
    </a>
    <a class="right-next"
       href="group3_lab1_julia.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lab 1 - Julia Code</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#math-demonstrations"><strong>Math Demonstrations</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prove-the-frisch-waugh-lovell-theorem">1. Prove the Frisch-Waugh-Lovell theorem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#show-that-the-conditional-expectation-function-minimizes-expected-squared-error">2. Show that the Conditional Expectation Function minimizes expected squared error</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-1-code"><strong>Replication 1 - Code</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-analysis">Data analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering-data-to-focus-on-college-advanced-educated-workers">Filtering data to focus on college-advanced-educated workers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploratory-data-analysis">Exploratory Data Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-validation-in-lasso-regression-manual-implementation-task"><strong>Cross-Validation in Lasso Regression - Manual Implementation Task</strong></a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Matias Villalba
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>